<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>PLAYBULB Candle Demo</title>
    <link rel="icon" sizes="192x192" href="favicon.png">

    <link rel="stylesheet" href="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.green-light_green.min.css">
    <script src="https://storage.googleapis.com/code.getmdl.io/1.0.4/material.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="styles.css">
    
    <!-- Pusher library for real-time communication -->
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    
    <!-- Pusher initialization script -->
    <script>
      // Enable pusher logging - don't include this in production
      Pusher.logToConsole = true;
      
      // Initialize Pusher with your credentials
      var pusher = new Pusher('49ed5dac5332dcd4c6a9', {
        cluster: 'eu'
      });
      
      // Subscribe to the channel
      var channel = pusher.subscribe('my-channel');
      
      // Bind to events and change candle color based on message
      channel.bind('my-event', function(data) {
        console.log('Pusher Event Received:', JSON.stringify(data, null, 2));
        console.log('Event Data:', data);
        
        // Extract color from the message
        // The color can be in data.color, data.message, or data itself (if it's a string)
        var colorName = null;
        
        if (data && typeof data === 'object') {
          // Try to get color from various possible fields
          colorName = data.color || data.message || data.name || data.text;
        } else if (typeof data === 'string') {
          // If data is directly a string, use it as the color name
          colorName = data;
        }
        
        // If we found a color name, change the candle color
        if (colorName) {
          console.log('Attempting to change candle color to:', colorName);
          // Wait for app.js to be loaded, then call the function
          // Try multiple times in case the script hasn't loaded yet
          var attempts = 0;
          var maxAttempts = 10;
          var checkFunction = setInterval(function() {
            attempts++;
            if (typeof changeColorFromPusher === 'function') {
              clearInterval(checkFunction);
              changeColorFromPusher(colorName);
            } else if (attempts >= maxAttempts) {
              clearInterval(checkFunction);
              console.error('changeColorFromPusher function not found after', maxAttempts, 'attempts. Make sure app.js is loaded.');
            }
          }, 100);
        } else {
          console.warn('No color found in Pusher message:', data);
        }
      });
      
      // Additional logging for connection status
      pusher.connection.bind('connected', function() {
        console.log('Pusher: Connected successfully');
      });
      
      pusher.connection.bind('error', function(err) {
        console.error('Pusher Connection Error:', err);
      });
    </script>
  </head>
  <body id="state">
    <div id="step1">
      <div id="title">PLAYBULB CANDLE DEMO</div>
      <button id="connect" class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-button--accent">CONNECT</button>
    </div>

    <div id="step2">
      <canvas></canvas>
      <input id="deviceName" type="text" maxlength="20">
      <div id="buttons">
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="noEffect">
        <input type="radio" id="noEffect" name="effectSwitch" class="mdl-radio__button" checked/>
        <span class="mdl-radio__label">No Effect</span>
      </label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="candleEffect">
        <input type="radio" id="candleEffect" name="effectSwitch" class="mdl-radio__button"/>
        <span class="mdl-radio__label">Candle Effect</span>
      </label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="flashing">
        <input type="radio" id="flashing" name="effectSwitch" class="mdl-radio__button"/>
        <span class="mdl-radio__label">Flashing</span>
      </label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="pulse">
        <input type="radio" id="pulse" name="effectSwitch" class="mdl-radio__button"/>
        <span class="mdl-radio__label">Pulse</span>
      </label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="rainbow">
        <input type="radio" id="rainbow" name="effectSwitch" class="mdl-radio__button"/>
        <span class="mdl-radio__label">Rainbow</span>
      </label>
      <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="rainbowFade">
        <input type="radio" id="rainbowFade" name="effectSwitch" class="mdl-radio__button"/>
        <span class="mdl-radio__label">Rainbow Fade</span>
      </label>
      </div>
      <div id="batteryLevel"></div>
      <div id="loading">
        <div class="mdl-spinner mdl-spinner--single-color mdl-js-spinner is-active"></div>
      </div>
    </div>

    <script src="playbulbCandle.js"></script>
    <script src="app.js"></script>
  </body>
</html>
